<!-- templates/index.html -->
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>CodeQL æœ¬åœ°åˆ†æå™¨</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; max-width: 900px; }
    h1 { margin-bottom: 6px; }
    .card { border: 1px solid #eee; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    label { display:block; margin-top:12px; }
    select,input[type=file] { width:100%; padding:8px; margin-top:6px; }
    button { margin-top:12px; padding:10px 16px; }
    #spinner { display:none; margin-top:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    table th, table td { border:1px solid #ddd; padding:8px; font-size:13px; }
    .level-info { color: #2c7; }
    .level-error { color: #d33; }
    .level-warning { color: #f60; }
    .small { font-size:12px; color:#666; }
    .download { margin-top:10px; display:inline-block; }
    #log { white-space:pre-wrap; background:#111; color:#0f0; padding:8px; margin-top:12px; display:none; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ğŸ”’ CodeQL æœ¬åœ°ä»£ç å®‰å…¨åˆ†æ</h1>

  <div class="card">
    <form id="analyzeForm">
      <label>â‘  é€‰æ‹©è¯­è¨€
        <select name="language" id="language">
          <option value="java">Java</option>
          <option value="python">Python</option>
          <option value="javascript">JavaScript</option>
          <option value="cpp">C / C++</option>
          <option value="csharp">C#</option>
        </select>
      </label>

      <label>â‘¡ é€‰æ‹©æŸ¥è¯¢å¥—ä»¶
        <select name="suite" id="suite">
          <!-- å¸¸ç”¨ä¸¤ä¸ªï¼Œåç«¯ä¹Ÿæ”¯æŒä¼ å…¥å®Œæ•´ .qls è·¯å¾„ -->
          <option value="code-scanning">code-scanning</option>
          <option value="security-and-quality">security-and-quality</option>
        </select>
      </label>

      <label>â‘¢ ä¸Šä¼ æ–‡ä»¶
        <input type="file" name="file" id="file" />
      </label>

      <button type="submit">å¼€å§‹åˆ†æ</button>
      <div id="spinner">â³ æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...</div>
    </form>

    <div id="resultArea" style="display:none;">
      <div class="small" id="statusMsg"></div>
      <a id="downloadLink" class="download" href="#" download>ä¸‹è½½ SARIF</a>
      <table id="resultsTable">
        <thead>
          <tr><th>è§„åˆ™</th><th>ä¸¥é‡æ€§</th><th>æ–‡ä»¶</th><th>è¡Œ</th><th>æ¶ˆæ¯</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="showLogBtn">æ˜¾ç¤º/éšè— è°ƒè¯•æ—¥å¿—</button>
      <div id="log"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("analyzeForm");
    const spinner = document.getElementById("spinner");
    const resultArea = document.getElementById("resultArea");
    const tableBody = document.querySelector("#resultsTable tbody");
    const statusMsg = document.getElementById("statusMsg");
    const downloadLink = document.getElementById("downloadLink");
    const logDiv = document.getElementById("log");
    const showLogBtn = document.getElementById("showLogBtn");

    showLogBtn.addEventListener("click", ()=> {
      logDiv.style.display = logDiv.style.display === "none" ? "block" : "none";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultArea.style.display = "none";
      tableBody.innerHTML = "";
      statusMsg.textContent = "";
      logDiv.textContent = "";

      const fileInput = document.getElementById("file");
      if (!fileInput.files.length) {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæºä»£ç æˆ– zipï¼‰");
        return;
      }

      spinner.style.display = "block";
      const fd = new FormData();
      fd.append("language", document.getElementById("language").value);
      fd.append("suite", document.getElementById("suite").value);
      fd.append("file", fileInput.files[0]);

      try {
        const resp = await fetch("/api/analyze", { method: "POST", body: fd });
        const data = await resp.json();
        spinner.style.display = "none";

        if (!resp.ok) {
          resultArea.style.display = "block";
          statusMsg.textContent = "âŒ åˆ†æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—";
          logDiv.style.display = "block";
          logDiv.textContent = JSON.stringify(data, null, 2);
          return;
        }

        // success
        resultArea.style.display = "block";
        statusMsg.textContent = "âœ… åˆ†æå®Œæˆï¼Œå¯ä¸‹è½½ç»“æœï¼š";
        downloadLink.href = "/results/" + data.sarif_file;
        downloadLink.textContent = "ä¸‹è½½ SARIF";
        downloadLink.style.display = "inline-block";

        // fill table
        tableBody.innerHTML = "";
        for (const r of data.results || []) {
          const tr = document.createElement("tr");
          const levelClass = r.level && r.level.toLowerCase().includes("error") ? "level-error" :
                             r.level && r.level.toLowerCase().includes("warn") ? "level-warning" : "level-info";
          tr.innerHTML = `<td>${escapeHtml(r.rule)}</td>
                          <td class="${levelClass}">${escapeHtml(r.level)}</td>
                          <td>${escapeHtml(r.file)}</td>
                          <td>${escapeHtml(r.line)}</td>
                          <td>${escapeHtml(r.message)}</td>`;
          tableBody.appendChild(tr);
        }

        // show debug SARIF name or other info
        logDiv.textContent = "è¿”å›æ•°æ®ï¼š\n" + JSON.stringify(data, null, 2);
      } catch (err) {
        spinner.style.display = "none";
        resultArea.style.display = "block";
        statusMsg.textContent = "âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯";
        logDiv.style.display = "block";
        logDiv.textContent = String(err);
      }
    });

    function escapeHtml(s) {
      if (!s && s !== 0) return "";
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }
  </script>
</body>
</html>