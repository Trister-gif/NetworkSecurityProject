{% extends "base.html" %}

{% block title %}æ™ºèƒ½è§„åˆ™ç”Ÿæˆ{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-magic"></i> AI è§„åˆ™ç”Ÿæˆå™¨</h1>
        <p class="subtitle">æè¿°ä½ æƒ³è¦æ£€æµ‹çš„æ¼æ´ï¼ŒAI Agent å°†ä¸ºä½ ç¼–å†™ CodeQL æŸ¥è¯¢è¯­å¥</p>
    </div>

    <!-- 1. åˆå§‹éœ€æ±‚å¡ç‰‡ -->
    <div class="card input-card" id="initialCard">
        <div class="card-header-flex">
            <h3><i class="fas fa-pen-nib"></i> åˆå§‹å®šä¹‰</h3>
            
            <!-- é‡æ–°å¼€å§‹æŒ‰é’® -->
            <button id="resetBtn" class="btn btn-sm btn-ghost" onclick="resetGenerator()" style="display:none;">
                <i class="fas fa-redo-alt"></i> é‡æ–°è®¾è®¡
            </button>
        </div>

        <form id="initialForm">
            <div class="form-group">
                <label>ğŸ” æ¼æ´ç±»å‹</label>
                <input type="text" class="form-control" id="vulnType" 
                       placeholder="ä¾‹å¦‚ï¼šSQL æ³¨å…¥, ç¡¬ç¼–ç å¯†ç , SSRF..." required>
            </div>
            <div class="form-group">
                <label>ğŸ“ ç”Ÿæˆè¦æ±‚</label>
                <textarea class="form-control" id="requirements" rows="4" 
                          placeholder="æè¿°å…·ä½“åœºæ™¯..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="generateBtn">
                <i class="fas fa-play"></i> å¼€å§‹ç”Ÿæˆ
            </button>
        </form>
    </div>

    <!-- 2. å¯¹è¯æµå®¹å™¨ -->
    <div id="chatContainer"></div>

    <!-- 3. åº•éƒ¨ Loading -->
    <div id="globalLoading" class="loading-state" style="display:none;">
        <div class="spinner-icon"></div>
        <p>AI æ­£åœ¨æ€è€ƒå¹¶ç¼–å†™ä»£ç ...</p>
    </div>

    <div style="height: 100px;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // === æ¨¡æ‹Ÿæ•°æ® ===
    const MOCK_CODE_BASE = `/**
 * @name Generated Rule
 * @description AI generated CodeQL query
 * @kind path-problem
 * @problem.severity error
 */
import python
import semmle.python.security.dataflow.SqlInjection

from SqlInjectionConfiguration config, DataFlow::PathNode source, DataFlow::PathNode sink
where config.hasFlowPath(source, sink)
select sink.node, source, sink, "Potential vulnerability here."
`;

    const chatContainer = document.getElementById('chatContainer');
    const globalLoading = document.getElementById('globalLoading');
    const initialForm = document.getElementById('initialForm');
    const resetBtn = document.getElementById('resetBtn');
    
    let turnCount = 0; 

    // 1. åˆå§‹æäº¤
    initialForm.addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('vulnType').disabled = true;
        document.getElementById('requirements').disabled = true;
        
        resetBtn.style.display = 'inline-block';
        resetBtn.classList.add('fade-in');

        startGeneration("åˆå§‹ç”Ÿæˆ");
    });

    // 2. é‡æ–°å¼€å§‹ (åŠ¨ç”»ç‰ˆ - æ— å¼¹çª—)
    function resetGenerator() {
        // A. æŒ‰é’®å›¾æ ‡æ—‹è½¬åŠ¨ç”» (è§†è§‰åé¦ˆ)
        const icon = resetBtn.querySelector('i');
        icon.classList.add('rotate-once');

        // B. å¯¹è¯æµåŒºåŸŸæ·¡å‡ºä¸‹æ²‰
        chatContainer.classList.add('fade-out-down');
        
        // C. è¡¨å•åŒºåŸŸè½»å¾®é—ªçƒï¼Œæš—ç¤ºæ­£åœ¨é‡ç½®
        const card = document.getElementById('initialCard');
        card.classList.add('flash-reset');

        // D. ç­‰å¾…åŠ¨ç”»ç»“æŸåæ‰§è¡ŒçœŸæ­£çš„æ¸…ç† (500ms)
        setTimeout(() => {
            // 1. æ¸…ç©ºå†…å®¹
            chatContainer.innerHTML = '';
            chatContainer.classList.remove('fade-out-down'); // ç§»é™¤ç±»ä»¥ä¾¿ä¸‹æ¬¡æ˜¾ç¤º
            
            turnCount = 0;

            // 2. é‡ç½®è¡¨å•å¹¶è§£é”
            const form = document.getElementById('initialForm');
            form.reset();
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('vulnType').disabled = false;
            document.getElementById('requirements').disabled = false;

            // 3. ç§»é™¤åŠ¨ç”»ç±»
            icon.classList.remove('rotate-once');
            card.classList.remove('flash-reset');

            // 4. éšè—é‡ç½®æŒ‰é’®
            resetBtn.style.display = 'none';

            // 5. æ»šå›é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
        }, 500); 
    }

    // 3. å¼€å§‹ç”Ÿæˆæµç¨‹
    function startGeneration(context) {
        globalLoading.style.display = 'block';
        globalLoading.scrollIntoView({ behavior: 'smooth' });

        setTimeout(() => {
            globalLoading.style.display = 'none';
            turnCount++;
            const codeContent = `// [ç¬¬ ${turnCount} ç‰ˆ] åŸºäº: ${context}\n` + MOCK_CODE_BASE;
            appendResultCard(codeContent, turnCount);
        }, 1500);
    }

    // 4. è¿½åŠ ç»“æœå¡ç‰‡
    function appendResultCard(code, id) {
        const cardId = `result-${id}`;
        
        const html = `
        <div class="card result-card fade-in-up" id="${cardId}">
            <div class="result-header">
                <h3><i class="fas fa-robot"></i> ç”Ÿæˆç»“æœ #${id}</h3>
                <span class="badge badge-info">AI Generated</span>
            </div>
            
            <div class="code-editor-container">
                <textarea id="editor-${id}" class="code-editor" readonly>${code}</textarea>
            </div>

            <div class="action-bar" id="actions-${id}">
                <div class="left-actions">
                    <button class="btn btn-secondary" onclick="toggleEdit('${id}')">
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </button>
                    <button id="save-btn-${id}" class="btn btn-success" onclick="saveRule('${id}')">
                        <i class="fas fa-save"></i> ä¿å­˜è§„åˆ™
                    </button>
                </div>
            </div>
        </div>
        `;

        chatContainer.insertAdjacentHTML('beforeend', html);
        appendRefineInput(id);
        document.getElementById(cardId).scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 5. è¿½åŠ â€œè¿½åŠ è¦æ±‚â€è¾“å…¥æ¡†
    function appendRefineInput(prevId) {
        const inputId = `refine-box-${prevId}`;
        const html = `
        <div class="refine-container fade-in-up" id="${inputId}">
            <div class="refine-label"><i class="fas fa-level-down-alt"></i> å¯¹ç»“æœä¸æ»¡æ„ï¼Ÿè¿½åŠ è¦æ±‚ï¼š</div>
            <div class="refine-input-group">
                <textarea class="form-control" id="text-${inputId}" rows="2" placeholder="ä¾‹å¦‚ï¼šè¯·æ’é™¤ test æ–‡ä»¶å¤¹..."></textarea>
                <button class="btn btn-warning" onclick="submitRefine('${prevId}', '${inputId}')">
                    <i class="fas fa-paper-plane"></i> å‘é€
                </button>
            </div>
        </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', html);
    }

    // 6. æäº¤è¿½åŠ è¦æ±‚
    function submitRefine(prevId, inputContainerId) {
        const textArea = document.getElementById(`text-${inputContainerId}`);
        const feedback = textArea.value.trim();
        if (!feedback) return alert("è¯·è¾“å…¥å…·ä½“çš„è¦æ±‚");

        const prevActions = document.getElementById(`actions-${prevId}`);
        if (prevActions) prevActions.remove(); 
        
        const prevCard = document.getElementById(`result-${prevId}`);
        prevCard.classList.add('history-card');
        
        const inputContainer = document.getElementById(inputContainerId);
        inputContainer.innerHTML = `
            <div class="user-message-card">
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-content"><strong>è¿½åŠ è¦æ±‚ï¼š</strong> ${escapeHtml(feedback)}</div>
            </div>
        `;

        startGeneration(feedback);
    }

    // å·¥å…·ï¼šåˆ‡æ¢ç¼–è¾‘çŠ¶æ€
    function toggleEdit(id) {
        const editor = document.getElementById(`editor-${id}`);
        const saveBtn = document.getElementById(`save-btn-${id}`);
        
        if (editor.hasAttribute('readonly')) {
            editor.removeAttribute('readonly');
            editor.classList.add('editable');
            
            if (saveBtn.classList.contains('btn-saved')) {
                saveBtn.classList.remove('btn-saved');
                saveBtn.classList.add('btn-success');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜è§„åˆ™';
            }
        } else {
            editor.setAttribute('readonly', true);
            editor.classList.remove('editable');
        }
    }

    // å·¥å…·ï¼šä¿å­˜è§„åˆ™
    function saveRule(id) {
        const btn = document.getElementById(`save-btn-${id}`);
        const editor = document.getElementById(`editor-${id}`);
        
        const originalWidth = btn.offsetWidth;
        btn.style.width = originalWidth + 'px';
        
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ä¿å­˜ä¸­...';
        
        setTimeout(() => {
            btn.style.width = 'auto'; 
            btn.classList.remove('btn-success');
            btn.classList.add('btn-saved'); 
            btn.innerHTML = '<i class="fas fa-check"></i> å·²æˆåŠŸä¿å­˜';
            btn.disabled = false;
        }, 800);
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
</script>
{% endblock %}